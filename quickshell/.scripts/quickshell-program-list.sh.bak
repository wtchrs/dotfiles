#!/usr/bin/env bash

set -euo pipefail

DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
DATA_DIRS="${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

IFS=':' read -ra DIRS <<<"$DATA_HOME:$DATA_DIRS"

declare -A seen

json_escape() {
    printf '%s' "$1" | sed \
        -e 's/\\/\\\\/g' \
        -e 's/"/\\"/g' \
        -e 's/\t/\\t/g' \
        -e 's/\r/\\r/g' \
        -e 's/\n/\\n/g'
}

for base in "${DIRS[@]}"; do
    appdir="$base/applications"
    [ -d "$appdir" ] || continue

    find "$appdir" -type f -name '*.desktop' 2>/dev/null | while read -r file; do
        name="$(basename "$file")"

        # XDG precedence: first one wins
        [[ -n "${seen[$name]:-}" ]] && continue
        seen[$name]=1

        grep -q '^Hidden=true' "$file" && continue
        grep -q '^NoDisplay=true' "$file" && continue

        if grep -q '^TryExec=' "$file"; then
            tryexec=$(grep -m1 '^TryExec=' "$file" | cut -d= -f2-)
            command -v "$tryexec" >/dev/null 2>&1 || continue
        fi

        NAME=$(grep -m1 "^Name=" "$file" | cut -d= -f2-)
        EXEC=$(grep -m1 "^Exec=" "$file" | cut -d= -f2-)
        ICON=$(grep -m1 "^Icon=" "$file" | cut -d= -f2-)

        # Remove all field codes
        EXEC=$(printf '%s' "$EXEC" | sed -E 's/%[a-zA-Z]//g' | xargs)

        printf '{'
        printf '"name":"%s",' "$(json_escape "$NAME")"
        printf '"exec":"%s",' "$(json_escape "$EXEC")"
        printf '"icon":"%s"' "$(json_escape "$ICON")"
        printf '}\n'
    done
done
